### this is a function file created to match the clinical_data_extract_DW.R file
### input files required: needs the results.master (RDS) which is generated by the clinPathAssess function

### names of functions
### extract.km.OS.pval
### extract.km.EFS.pval
### extract.km.PFS.pval
### cox.dataframe
### extract.cox
### extract.cox.OS
### log.reg.dataframe

##################################################################################################################################
### univariate
##################################################################################################################################

### km.OS
extract.km.OS.pval <- function(results.master, name){
  extracted.km.OS.pval <- lapply(results.master, function(x){return(x[["surv.p.values.list"]][[name]][["OS.p.val"]])}) 
  km.OS.p.extract.assembled <- do.call(rbind, extracted.km.OS.pval)
  adjusted.p.km.OS<-p.adjust(km.OS.p.extract.assembled, method = "BH") 
  OS.pvalue <- cbind(km.OS.p.extract.assembled, adjusted.p.km.OS)
  colnames(OS.pvalue) <- c("OS.p.value", "OS.adjusted.pval")
  return(OS.pvalue)
} 

### km.PFS
extract.km.PFS.pval <- function(results.master, name){
  extracted.km.PFS.pval<- lapply(results.master, function(x){return(x[["surv.p.values.list"]][[name]][["PFS.p.val"]])}) 
  km.PFS.p.extract.assembled <- do.call(rbind, extracted.km.PFS.pval)
  adjusted.p.km.PFS <-p.adjust(km.PFS.p.extract.assembled, method = "BH") 
  PFS.pvalue <- cbind(km.PFS.p.extract.assembled, adjusted.p.km.PFS)
  colnames(PFS.pvalue) <- c("PFS.p.value", "PFS.adjusted.pval")
  return(PFS.pvalue)
} 

### km.EFS
extract.km.EFS.pval <- function(results.master, name){
  extracted.km.EFS.pval<- lapply(results.master, function(x){return(x[["surv.p.values.list"]][[name]][["EFS.p.val"]])}) 
  km.EFS.p.extract.assembled <- do.call(rbind, extracted.km.EFS.pval)
  adjusted.p.km.EFS <-p.adjust(km.EFS.p.extract.assembled, method = "BH") 
  EFS.pvalue <- cbind(km.EFS.p.extract.assembled, adjusted.p.km.EFS)
  colnames(EFS.pvalue) <- c("EFS.p.value", "EFS.adjusted.pval")
  return(EFS.pvalue)
} 

###
cox.dataframe <- function(pval, Zscore, HR, L95CI, U95CI){
  cox.pval.assembled <- do.call(rbind, pval)
  adj.cox.pval <- p.adjust(cox.pval.assembled, method = "BH")
  #cox.pval.combined.df <- cbind(cox.pval.assembled, adj.cox.pval)
  #colnames(cox.pval.combined.df)<-c("cox.pval", "cox.adj.pval")
  cox.Zscore.assembled <- do.call(rbind, Zscore)
  cox.HR.assembled <- do.call(rbind, HR)
  cox.L95CI.assembled <- do.call(rbind, L95CI)
  cox.U95CI.assembled <- do.call(rbind, U95CI)
  cox.allresults.df <- cbind(cox.pval.assembled, adj.cox.pval, cox.Zscore.assembled, cox.HR.assembled, cox.L95CI.assembled, cox.U95CI.assembled)
  colnames(cox.allresults.df)<- c("cox.pval", "cox.adj.pval", "cox.Zscore","cox.HR", "cox.HR.L95CI", "cox.HR.U95CI" )
  return (cox.allresults.df)
}

### Extract.cox function for univariate cox regression

### names(results.master[[1]]) gives "cox.p.values.list" as slot 4
### names(results.master[[1]][[4]][[1]]) "cox.pval", "cox.HR", "cox.lower.95CI", "cox.upper.95CI", "cox.Zscore", "n", "n.event"
### subset.index <- 1

 extract.cox <- function (results.master, subset.index){
   cox.dataframe (pval = lapply(results.master, function (x, subset.index){return (x[["cox.p.values.list"]][[subset.index]][["cox.pval"]])}, subset.index = subset.index),
                  Zscore = lapply(results.master, function (x, subset.index){return(x[["cox.p.values.list"]][[subset.index]][["cox.Zscore"]])}, subset.index = subset.index), 
                  HR = lapply(results.master, function (x, subset.index){return(x[["cox.p.values.list"]][[subset.index]][["cox.HR"]])},subset.index = subset.index ),
                  L95CI = lapply(results.master, function (x, subset.index){return(x[["cox.p.values.list"]][[subset.index]][["cox.lower.95CI"]])}, subset.index = subset.index),
                  U95CI = lapply(results.master, function (x, subset.index){return(x[["cox.p.values.list"]][[subset.index]][["cox.upper.95CI"]])}, subset.index = subset.index)
   )
 }

 
 extract.cox.OS <- function (results.master, subset.index){
   cox.dataframe (pval = lapply(results.master, function (x, subset.index){return (x[["cox.p.values.list"]][[subset.index]][["cox.OS.p.val"]])}, subset.index = subset.index),
                  Zscore = lapply(results.master, function (x, subset.index){return(x[["cox.p.values.list"]][[subset.index]][["cox.OS.Zscore"]])}, subset.index = subset.index), 
                  HR = lapply(results.master, function (x, subset.index){return(x[["cox.p.values.list"]][[subset.index]][["cox.OS.HR"]])},subset.index = subset.index ),
                  L95CI = lapply(results.master, function (x, subset.index){return(x[["cox.p.values.list"]][[subset.index]][["cox.OS.lower.95CI"]])}, subset.index = subset.index),
                  U95CI = lapply(results.master, function (x, subset.index){return(x[["cox.p.values.list"]][[subset.index]][["cox.OS.upper.95CI"]])}, subset.index = subset.index)
   )
 }
                  
 
##################################################################################################################################
### multivariate
##################################################################################################################################

extract.multivar.cox <- function(results.master, subset.index){
  cox.dataframe (pval = lapply(results.master, function (x, subset.index){return(x[["cox.multivar.p.values.list"]][[subset.index]][["cox.pval"]])}, subset.index = subset.index), 
                 Zscore = lapply(results.master, function (x, subset.index){return(x[["cox.multivar.p.values.list"]][[subset.index]][["cox.Zscore"]])}, subset.index = subset.index), 
                 HR = lapply(results.master, function (x, subset.index){return(x[["cox.multivar.p.values.list"]][[subset.index]][["cox.HR"]])},subset.index = subset.index ),
                 L95CI = lapply(results.master, function (x, subset.index){return(x[["cox.multivar.p.values.list"]][[subset.index]][["cox.lower.95CI"]])}, subset.index = subset.index),
                 U95CI = lapply(results.master, function (x, subset.index){return(x[["cox.multivar.p.values.list"]][[subset.index]][["cox.upper.95CI"]])}, subset.index = subset.index )
  )               
}

 
##################################################################################################################################
### Troubleshooting
##################################################################################################################################
### unhash here if troubleshooting with individual functions
 
 # results.master = results.master #
 # subset.index = 1                #
 
# "multivar.cox.PFS.Lancet.G3G4.cat" -> subset.index

####################################
### if wish to check the individual function, could run cox.dataframe(pval... onwards) to create dataframe to check


##############################################

### for logistic regression

log.reg.dataframe <- function(pval, OR, L95CI, U95CI){
  logreg.pval.assembled <- do.call(rbind, pval) ### check if recurrent error here when more than one input goi
  logreg.adj.pval <- p.adjust(logreg.pval.assembled, method = "BH")
  logreg.OR.assembled <- do.call(rbind, OR)
  logreg.L95CI.assembled <- do.call(rbind, L95CI)
  logreg.U95CI.assembled <- do.call(rbind, U95CI)
  logreg.allresults.df <- cbind(logreg.pval.assembled, logreg.adj.pval, logreg.OR.assembled, logreg.L95CI.assembled, logreg.U95CI.assembled)
  colnames(logreg.allresults.df)<- c("logreg.pval", "logreg.adj.pval","logreg.OR", "logreg.OR.L95CI", "logreg.OR.U95CI" )
  return (logreg.allresults.df)
}



##############################################
### function for extracting chi squared results
### this will work for all variables that have been run in chi squared test

extract.chi.all <- function(results.master, name){
  extracted.chi.all.pval <- lapply(results.master, function(x){return(x[["chi.sq.list"]][[name]][["p.value"]])}) 
  extracted.chi.all.pval.assembled <- do.call(rbind, extracted.chi.all.pval)
  adjusted.p.chi.all <-p.adjust(extracted.chi.all.pval.assembled, method = "BH") 
  chi.pvalue <- cbind(extracted.chi.all.pval.assembled, adjusted.p.chi.all)
  colnames(chi.pvalue) <- c("chi.p.value", "adjusted.pval")
  return(chi.pvalue)
} 


##############################################


### cox OS dataframe

# cox.OS.cat.all.df <- cox.dataframe(pval = cox.OS.pval.cat.all , Zscore = cox.OS.Zscore.cat.all, HR = cox.OS.HR.cat.all, L95CI = cox.L95CI.OS.HR.cat.all, U95CI = cox.U95CI.OS.HR.cat.all)
# colnames(cox.OS.cat.all.df) <- c("cox.OS.pval.cat.all", "cox.OS.adj.pval.cat.all", "cox.OS.Zscore.cat.all", "cox.OS.HR.cat.all","cox.L95CI.OS.HR.cat.all", "cox.U95CI.OS.HR.cat.all")

# significant.cox.OS.cat.all <- cox.OS.cat.all.df[which(cox.OS.cat.all.df[, 2]<0.05),]
#
# write.csv(significant.cox.OS.cat.all,  file = "/home/nmm199/R/MB_RNAseq/Clinical/clin.results/significant.cox.OS.complete.cat.all.csv")

###################
###################
### superceded function as of 4/12/17 as returns subset out of bounds error

# extractKM <- function(results.master, subset.index){
#  pval <- lapply(results.master, function(x){return(x[[1]][[subset.index]][[1]])}) 
#  pval <- do.call(rbind, pval)
#  adj.pval <-p.adjust(pval, method = "BH") 
#  temp.return <- cbind(pval, adj.pval)
#  colnames(temp.return) <- c("pval", "adj.pval")
#  return(temp.return)
# }

###############################
### previous code for extract.multivar.cox.pval when used subsetting, replaced 6/2/18 
### overall function

#extract.multivar.cox <- function(results.master, subset.index){
#  cox.dataframe (pval = lapply(results.master, extract.multivar.cox.pval, subset.index = subset.index), 
#                 Zscore = lapply(results.master, extract.multivar.cox.Zscore, subset.index = subset.index), 
#                 HR = lapply(results.master, extract.multivar.cox.HR,subset.index = subset.index ),
#                 L95CI = lapply(results.master, extract.multivar.cox.L95CI, subset.index = subset.index),
#                 U95CI = lapply(results.master, extract.multivar.cox.U95CI, subset.index = subset.index )
#  )               
#}



# extract.multivar.cox.pval <-  function (x, subset.index){
#  return(ifelse(length(x[[5]])< 1, NA, ### was 3
 #               ifelse(length(x[[5]][[subset.index]])< 6, NA,  ### was < 6
  #                     ifelse(length(x[[5]][[subset.index]][[1]])<1, NA,
   #                           x[[5]][[subset.index]][[1]]))))
# }


# extract.multivar.cox.HR <- function (x, subset.index){
#  return(ifelse(length(x[[5]])< 1, NA, 
 #               ifelse(length(x[[5]][[subset.index]])< 6, NA, 
  #                     ifelse(length(x[[5]][[subset.index]][[2]])<1, NA,
   #                           x[[5]][[subset.index]][[2]]))))
# }




# extract.multivar.cox.Zscore <- function (x, subset.index){
#  return(ifelse(length(x[[5]])< 1, NA,
 #               ifelse(length(x[[5]][[subset.index]])< 6, NA, 
  #                     ifelse(length(x[[5]][[subset.index]][[5]])<1, NA,
   #                           x[[5]][[subset.index]][[5]]))))
# }



# extract.multivar.cox.L95CI<- function (x, subset.index){
#  return(ifelse(length(x[[5]])< 1, NA, 
 #               ifelse(length(x[[5]][[subset.index]])< 6, NA, 
  #                     ifelse(length(x[[5]][[subset.index]][[3]])<1, NA,
   #                           x[[5]][[subset.index]][[3]]))))
# }


# extract.multivar.cox.U95CI <- function (x, subset.index){
#  return(ifelse(length(x[[5]])< 1, NA, 
 #               ifelse(length(x[[5]][[subset.index]])<6, NA, 
  #                     ifelse(length(x[[5]][[subset.index]][[4]])<1, NA,
   #                           x[[5]][[subset.index]][[4]]))))
# }

